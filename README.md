# MotoRoller: Motorola GM remote control

MotoRoller - кроссплатформенный веб-сервер с открытым исходным кодом, созданный силами сообщества Satcom Pirates.

На сегодняшний день поддерживается:
- управление радиостанциями Motorola GM 1280, GM360 с зонами
- голосовой траффик через WebRTC в браузерах Firefox & Chrome
- работа на одноплатных компьютерах, в частности на Orange PI Zero 2

https://user-images.githubusercontent.com/90838159/186971130-ab151ed4-0c0b-4ded-856b-98d162e6c4db.mp4

## Настройка dotnet
Для работы веб-сервера требуется dotnet runtime. 
- Установите dotnet runtime под вашу ОС (Linux/Windows) https://dotnet.microsoft.com/en-us/download/dotnet/6.0
- Запустите командную строку с правами администратора
- Сгенерируйте сертификат командой ```dotnet dev-certs https```. В случае успеха вы увидите сообщение ```The HTTPS developer certificate was generated successfully```
- Сделайте сертификат доверенным ```dotnet dev-certs https --trust```

## Быстрый старт (только управление, без звука)
- Подключите программатор к станции и компьютеру
- Скачайте и распакуйте архив
- Откройте appsettings.json любым текстовым редактором
- В строке "SerialPort": укажите порт, к которому подключен программатор станции. Пример для windows "SerialPort":"COM6", для linux "SerialPort": "/dev/ttyS1"
- Откройте командную строку или терминал.
- Запустите программу командой dotnet MotoRoller.dll --urls [http://0.0.0.0:80](http://0.0.0.0/) , где 80 - порт на котором будет запущен веб-сервер. Можно использовать другой порт по вашему усмотрению.
- Включите радиостанцию.
- Откройте браузер по адресу http://localhost/

Управление функционалом станции происходит по шине BUS+. Подключиться к ней можно двумя способами: 
 - через задний аксессуарный разъем,
 - через фронтальный разъем.
 
Аудио сигналы по этой шине не передаются.

## Коммутация аудио цепей
Для того, чтобы работали звуковые функции, потребуется сигнал с аудиовыхода станции подать на микрофонный либо линейный вход звуковой карты компьютера (сервера). В свою очередь  сигнал с аудио выхода звуковой карты компьютера подать на микрофонный вход станции. Важным моментом является то, что сигнал на микрофонный вход станции требуется подать именно на передний разъем станции. Эта особенность связана с тем, что при подаче команды PTT по Data-кабелю (через BUS+), включается вход микрофона только на передней панели.
Можно использовать на компьютере звуковую карту как с тремя разъемами (в этом случае используются разъемы "Line in" и "Line out"), так и с двумя разъемами (в этом случае используются разъемы "Mic" и "Line out").

Чтобы подключиться к аудио точкам фронтального разъема, гнездо можно вынести на кабельной сборке, состоящей из отрезка кабеля UTP 4p и двух разъемов RG-45 (мама и папа). Для таких целей можно использовать внутренности компьютерной LAN розетки.

![изображение](https://user-images.githubusercontent.com/90838159/211718471-8a979c83-6b3c-43c1-b774-15e6217f3706.png)
![изображение](https://user-images.githubusercontent.com/90838159/211718509-4b6dc211-ec7c-4f8b-b254-c9760f43513b.png)
![изображение](https://user-images.githubusercontent.com/90838159/211718535-7a7676b3-6488-408b-ba99-82a73da2af32.png)

В случае если в качестве сервера используется компьютер, у которого один единственный совмещенный аудио разъем, то для сборки аудио кабеля используется 4-х контактный jack-разъем (как на фото выше). В этом случае распайка будет следующая:

![изображение](https://user-images.githubusercontent.com/90838159/211721823-f591e6ee-8b24-4020-b189-dfd1ecb783ee.png)

## Настройка https для удаленного приема\передачи звука
Аудио функции будут работать только если ваш канал связи с сервером является защищенным (с использованием SSL сертификата), то есть соединение по Https (а не по http). После того как установите DotNet, необходимо сгенерировать SSL сертификат разработчика. Без него невозможно запустить web сервер в защищенном режиме (HTTPS). 
Для генерации сертификата откройте командную строку от имени Администатора и сгенерируйте сертификат SSL командой 
```dotnet dev-certs https```. В случае успеха вы увидите сообщение ```The HTTPS developer certificate was generated successfully```.
Далее, следующей командой сделаем сертификат доверенным: ```dotnet dev-certs https --trust```.

## Публикация сервера в интернет

Для работы с web сервером из зоны интернета, лучше стартовать его не на localhost (0.0.0.0), а на IP адрес сетевой карты компьютера. Если адрес не прописан руками в настройках сетевой карты и не является постоянным, то необходимо его зарезервировать в настройках роутера для сетевой карты вашего компьютера как постоянный.
Для старта сервера, можно использовать не 80-й порт, а какой-нибудь нестандартный. Например 777 или любой другой.
В итоге строка запуска сервера будет примерно такой:  
dotnet MotoRoller.dll --urls https://192.168.1.47:777
Для доступа извне к web серверу идеально подойдет роутер Keenetic с его [бесплатными доменами](https://keenetic.pro/), и бесплатным сертификатом SSL выпускаемым к ним. При этом тип выдаваемого провайдером вам IP адреса абсолютно не важен. Так же в Кинетике есть удобная функция организации быстрого доступа к web службам локальной сети путем создания поддомена с указанием внутреннего ресурса и одновременной переадресацией порта.
Допустим вы сгенерировали себе домен tolimbo.keenetic.pro, в этом случае для доступа к web серверу можно сделать поддомен "gm360", указать что к службе надо обращаться по https и выбрать в качестве принимающего адреса адрес сетевой карты вашего сервера.
И адрес доступа к серверу из зоны интерна будет выглядеть как https://gm360.tolimbo.keenetic.pro

## Подготовка сервера к аудио сессии
Cвязь организуется между страницей браузера открытой на сервере (!) и странице браузера открытой у клиента(!). При этом важным моментом является то, что страницу в браузере сервера надо открывать по внешнему адресу вашего домена (!) а не по внутрисетевому адресу. И с использованием в конце адреса ключа /?moto (ключ всегда такой и не связан с нашим придуманным поддоменом)
Адресная строка в браузере сервера будет выглядеть так: https://gm360.tolimbo.keenetic.pro/?moto
Адресная строка в браузере клиента будет выглядеть как: https://gm360.tolimbo.keenetic.pro
Если все настроено как положено, то при открытии страницы в браузере будет задан вопрос о разрешении использования микрофона.
В результате опытов выяснилось, что самым оптимальным браузером оказался Mozilla Firefox. Только этот браузер оказался единственным, кто оповещал о том, что к странице сервера в браузере подключились (надписью "воспроизведение" на ярлыке страницы). Так же надо отметить, что периодически звук на клиентской стороне в браузере может пропадать. В этом случае просто обновите страницу.

## Прочее
- Версию Dotnet надо использовать исключительно ту, которая указана в конфигах сервера. Не пытайтесь выправить руками в конфгах версию на другую и устанавливать другую (пусть даже более новую).

- Сначала запускаем ПО, только потом включаем станцию! Если программатор подключен к ПК/Raspberry но данные из порта никто не читает (не запущено ПО), станция может перестать отзываться на клавиши, это обычное и нормальное поведение. 

## Download
Скачать последнюю версию можно здесь https://github.com/satcom-uhf/MotoRoller/releases


## Особая благодарность

YAMAL - идея, теоретическая подготовка, Motorola Confidential Proprietary документация

TURBINA, 999 - тестирование

OBERON, Oxotnuk и Радуга - за предоставленное оборудование

=Barracuda= - тестирование и написание Readme
